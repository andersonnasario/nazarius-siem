package main

import (
	"net/http"
	"time"

	"github.com/gin-gonic/gin"
)

// Vulnerability representa uma vulnerabilidade detectada
type Vulnerability struct {
	ID              string    `json:"id"`
	CVEID           string    `json:"cve_id"` // CVE-2024-12345
	Title           string    `json:"title"`
	Description     string    `json:"description"`
	Severity        string    `json:"severity"` // critical, high, medium, low
	CVSSScore       float64   `json:"cvss_score"` // 0.0 - 10.0
	CVSSVector      string    `json:"cvss_vector"`
	Status          string    `json:"status"` // open, in_progress, patched, accepted_risk, false_positive
	AffectedAssets  []string  `json:"affected_assets"`
	AssetCount      int       `json:"asset_count"`
	DetectedAt      time.Time `json:"detected_at"`
	LastSeen        time.Time `json:"last_seen"`
	PatchAvailable  bool      `json:"patch_available"`
	PatchVersion    string    `json:"patch_version,omitempty"`
	ExploitAvailable bool     `json:"exploit_available"`
	AssignedTo      string    `json:"assigned_to,omitempty"`
	DueDate         *time.Time `json:"due_date,omitempty"`
	RemediationNotes string   `json:"remediation_notes,omitempty"`
	RelatedCase     string    `json:"related_case,omitempty"`
	References      []string  `json:"references,omitempty"`
}

// VulnerableAsset representa um ativo vulnerável
type VulnerableAsset struct {
	ID                string               `json:"id"`
	Hostname          string               `json:"hostname"`
	IPAddress         string               `json:"ip_address"`
	AssetType         string               `json:"asset_type"` // server, workstation, network_device, etc
	OS                string               `json:"os"`
	OSVersion         string               `json:"os_version"`
	Criticality       string               `json:"criticality"` // critical, high, medium, low
	Owner             string               `json:"owner"`
	Location          string               `json:"location"`
	VulnerabilityCount int                 `json:"vulnerability_count"`
	CriticalVulns     int                  `json:"critical_vulns"`
	HighVulns         int                  `json:"high_vulns"`
	RiskScore         float64              `json:"risk_score"` // 0-100
	LastScanned       time.Time            `json:"last_scanned"`
	Vulnerabilities   []VulnerabilityRef   `json:"vulnerabilities,omitempty"`
}

// VulnerabilityRef é uma referência simplificada a uma vulnerabilidade
type VulnerabilityRef struct {
	ID         string  `json:"id"`
	CVEID      string  `json:"cve_id"`
	Severity   string  `json:"severity"`
	CVSSScore  float64 `json:"cvss_score"`
}

// VulnerabilityScan representa um scan de vulnerabilidades
type VulnerabilityScan struct {
	ID                string    `json:"id"`
	Name              string    `json:"name"`
	Status            string    `json:"status"` // running, completed, failed
	StartedAt         time.Time `json:"started_at"`
	CompletedAt       *time.Time `json:"completed_at,omitempty"`
	Duration          int       `json:"duration"` // em segundos
	AssetsScanned     int       `json:"assets_scanned"`
	VulnsFound        int       `json:"vulns_found"`
	CriticalFound     int       `json:"critical_found"`
	HighFound         int       `json:"high_found"`
	MediumFound       int       `json:"medium_found"`
	LowFound          int       `json:"low_found"`
	ScanType          string    `json:"scan_type"` // full, quick, targeted
	InitiatedBy       string    `json:"initiated_by"`
}

// VulnerabilityStats representa estatísticas gerais
type VulnerabilityStats struct {
	TotalVulnerabilities   int     `json:"total_vulnerabilities"`
	CriticalVulns          int     `json:"critical_vulns"`
	HighVulns              int     `json:"high_vulns"`
	MediumVulns            int     `json:"medium_vulns"`
	LowVulns               int     `json:"low_vulns"`
	OpenVulns              int     `json:"open_vulns"`
	PatchedVulns           int     `json:"patched_vulns"`
	InProgressVulns        int     `json:"in_progress_vulns"`
	AverageRemediationTime int     `json:"average_remediation_time"` // em dias
	PatchCompliance        float64 `json:"patch_compliance"` // %
	TotalAssets            int     `json:"total_assets"`
	VulnerableAssets       int     `json:"vulnerable_assets"`
	AssetsWithCritical     int     `json:"assets_with_critical"`
	LastScanDate           time.Time `json:"last_scan_date"`
	NextScheduledScan      time.Time `json:"next_scheduled_scan"`
}

// VulnerabilityTrend representa tendência de vulnerabilidades
type VulnerabilityTrend struct {
	Date      string `json:"date"`
	Critical  int    `json:"critical"`
	High      int    `json:"high"`
	Medium    int    `json:"medium"`
	Low       int    `json:"low"`
	Total     int    `json:"total"`
}

// PatchStatus representa status de patching
type PatchStatus struct {
	AssetID       string    `json:"asset_id"`
	AssetName     string    `json:"asset_name"`
	PatchName     string    `json:"patch_name"`
	Status        string    `json:"status"` // pending, installed, failed
	ScheduledDate time.Time `json:"scheduled_date"`
	InstalledDate *time.Time `json:"installed_date,omitempty"`
}

// Handlers

// handleGetVulnerabilityDashboard retorna o dashboard completo
func (s *APIServer) handleGetVulnerabilityDashboard(c *gin.Context) {
	stats := generateMockVulnerabilityStats()
	topVulns := generateMockVulnerabilities(5, "")
	topAssets := generateMockVulnerableAssets(5)
	trends := generateMockVulnerabilityTrends(7)
	
	c.JSON(http.StatusOK, gin.H{
		"stats":             stats,
		"top_vulnerabilities": topVulns,
		"top_assets":        topAssets,
		"trends":            trends,
	})
}

// handleListVulnerabilities retorna lista de vulnerabilidades
func (s *APIServer) handleListVulnerabilities(c *gin.Context) {
	severity := c.Query("severity")
	status := c.Query("status")
	
	vulns := generateMockVulnerabilities(50, severity)
	
	// Filtrar por status se especificado
	if status != "" {
		filtered := []Vulnerability{}
		for _, v := range vulns {
			if v.Status == status {
				filtered = append(filtered, v)
			}
		}
		vulns = filtered
	}
	
	c.JSON(http.StatusOK, gin.H{
		"vulnerabilities": vulns,
		"total":           len(vulns),
	})
}

// handleGetVulnerability retorna detalhes de uma vulnerabilidade
func (s *APIServer) handleGetVulnerability(c *gin.Context) {
	vulnID := c.Param("id")
	
	// Mock: retornar vulnerabilidade detalhada
	vuln := generateMockVulnerability(vulnID)
	c.JSON(http.StatusOK, vuln)
}

// handleUpdateVulnerability atualiza uma vulnerabilidade
func (s *APIServer) handleUpdateVulnerability(c *gin.Context) {
	vulnID := c.Param("id")
	
	var update struct {
		Status           string     `json:"status"`
		AssignedTo       string     `json:"assigned_to,omitempty"`
		DueDate          *time.Time `json:"due_date,omitempty"`
		RemediationNotes string     `json:"remediation_notes,omitempty"`
	}
	
	if err := c.ShouldBindJSON(&update); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}
	
	// Mock: retornar vulnerabilidade atualizada
	vuln := Vulnerability{
		ID:               vulnID,
		Status:           update.Status,
		AssignedTo:       update.AssignedTo,
		DueDate:          update.DueDate,
		RemediationNotes: update.RemediationNotes,
	}
	
	c.JSON(http.StatusOK, vuln)
}

// handleListVulnerableAssets retorna lista de ativos vulneráveis
func (s *APIServer) handleListVulnerableAssets(c *gin.Context) {
	assets := generateMockVulnerableAssets(20)
	c.JSON(http.StatusOK, gin.H{
		"assets": assets,
		"total":  len(assets),
	})
}

// handleGetVulnerableAsset retorna detalhes de um ativo vulnerável
func (s *APIServer) handleGetVulnerableAsset(c *gin.Context) {
	assetID := c.Param("id")
	asset := generateMockVulnerableAsset(assetID)
	c.JSON(http.StatusOK, asset)
}

// handleListScans retorna lista de scans
func (s *APIServer) handleListScans(c *gin.Context) {
	scans := generateMockScans()
	c.JSON(http.StatusOK, gin.H{
		"scans": scans,
		"total": len(scans),
	})
}

// handleCreateScan inicia um novo scan
func (s *APIServer) handleCreateScan(c *gin.Context) {
	var request struct {
		Name     string   `json:"name"`
		ScanType string   `json:"scan_type"` // full, quick, targeted
		Targets  []string `json:"targets,omitempty"`
	}
	
	if err := c.ShouldBindJSON(&request); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
		return
	}
	
	// Mock: criar scan
	scan := VulnerabilityScan{
		ID:          "scan-" + time.Now().Format("20060102150405"),
		Name:        request.Name,
		Status:      "running",
		StartedAt:   time.Now(),
		ScanType:    request.ScanType,
		InitiatedBy: "admin@company.com",
	}
	
	c.JSON(http.StatusCreated, scan)
}

// handleGetScan retorna detalhes de um scan
func (s *APIServer) handleGetScan(c *gin.Context) {
	scanID := c.Param("id")
	scan := generateMockScan(scanID)
	c.JSON(http.StatusOK, scan)
}

// handleGetVulnerabilityStats retorna estatísticas
func (s *APIServer) handleGetVulnerabilityStats(c *gin.Context) {
	stats := generateMockVulnerabilityStats()
	c.JSON(http.StatusOK, stats)
}

// Mock Data Generators

func generateMockVulnerabilityStats() VulnerabilityStats {
	now := time.Now()
	return VulnerabilityStats{
		TotalVulnerabilities:   247,
		CriticalVulns:          23,
		HighVulns:              67,
		MediumVulns:            98,
		LowVulns:               59,
		OpenVulns:              134,
		PatchedVulns:           89,
		InProgressVulns:        24,
		AverageRemediationTime: 14,
		PatchCompliance:        76.5,
		TotalAssets:            342,
		VulnerableAssets:       127,
		AssetsWithCritical:     18,
		LastScanDate:           now.AddDate(0, 0, -2),
		NextScheduledScan:      now.AddDate(0, 0, 5),
	}
}

func generateMockVulnerabilities(count int, severityFilter string) []Vulnerability {
	now := time.Now()
	vulns := []Vulnerability{
		{
			ID:              "vuln-001",
			CVEID:           "CVE-2024-12345",
			Title:           "Remote Code Execution in Apache Log4j",
			Description:     "A critical vulnerability allows remote code execution through JNDI lookup",
			Severity:        "critical",
			CVSSScore:       9.8,
			CVSSVector:      "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
			Status:          "open",
			AffectedAssets:  []string{"server-01", "server-02", "server-05"},
			AssetCount:      3,
			DetectedAt:      now.AddDate(0, 0, -5),
			LastSeen:        now,
			PatchAvailable:  true,
			PatchVersion:    "2.17.1",
			ExploitAvailable: true,
			References:      []string{"https://nvd.nist.gov/vuln/detail/CVE-2024-12345"},
		},
		{
			ID:              "vuln-002",
			CVEID:           "CVE-2024-23456",
			Title:           "SQL Injection in Web Application",
			Description:     "SQL injection vulnerability in login form allows unauthorized access",
			Severity:        "high",
			CVSSScore:       8.6,
			CVSSVector:      "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:L",
			Status:          "in_progress",
			AffectedAssets:  []string{"web-server-01"},
			AssetCount:      1,
			DetectedAt:      now.AddDate(0, 0, -10),
			LastSeen:        now,
			PatchAvailable:  true,
			PatchVersion:    "3.2.1",
			ExploitAvailable: false,
			AssignedTo:      "dev-team@company.com",
			DueDate:         timePtr(now.AddDate(0, 0, 3)),
			RemediationNotes: "Patch scheduled for next maintenance window",
		},
		{
			ID:              "vuln-003",
			CVEID:           "CVE-2024-34567",
			Title:           "Privilege Escalation in Linux Kernel",
			Description:     "Local privilege escalation through race condition",
			Severity:        "high",
			CVSSScore:       7.8,
			CVSSVector:      "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
			Status:          "patched",
			AffectedAssets:  []string{"server-03", "server-04"},
			AssetCount:      2,
			DetectedAt:      now.AddDate(0, 0, -20),
			LastSeen:        now.AddDate(0, 0, -15),
			PatchAvailable:  true,
			PatchVersion:    "5.15.0-89",
			ExploitAvailable: false,
			AssignedTo:      "infra-team@company.com",
		},
		{
			ID:              "vuln-004",
			CVEID:           "CVE-2024-45678",
			Title:           "Cross-Site Scripting (XSS) in Dashboard",
			Description:     "Stored XSS vulnerability in user profile field",
			Severity:        "medium",
			CVSSScore:       6.1,
			CVSSVector:      "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
			Status:          "open",
			AffectedAssets:  []string{"web-app-01"},
			AssetCount:      1,
			DetectedAt:      now.AddDate(0, 0, -3),
			LastSeen:        now,
			PatchAvailable:  true,
			PatchVersion:    "2.5.3",
			ExploitAvailable: false,
		},
		{
			ID:              "vuln-005",
			CVEID:           "CVE-2024-56789",
			Title:           "Information Disclosure in API",
			Description:     "API exposes sensitive information without authentication",
			Severity:        "medium",
			CVSSScore:       5.3,
			CVSSVector:      "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
			Status:          "open",
			AffectedAssets:  []string{"api-server-01"},
			AssetCount:      1,
			DetectedAt:      now.AddDate(0, 0, -7),
			LastSeen:        now,
			PatchAvailable:  false,
		},
	}
	
	// Filtrar por severidade se especificado
	if severityFilter != "" {
		filtered := []Vulnerability{}
		for _, v := range vulns {
			if v.Severity == severityFilter {
				filtered = append(filtered, v)
			}
		}
		vulns = filtered
	}
	
	// Retornar quantidade solicitada
	if count < len(vulns) {
		return vulns[:count]
	}
	
	// Gerar mais se necessário
	result := []Vulnerability{}
	for i := 0; i < count; i++ {
		result = append(result, vulns[i%len(vulns)])
	}
	
	return result
}

func generateMockVulnerability(id string) Vulnerability {
	now := time.Now()
	return Vulnerability{
		ID:              id,
		CVEID:           "CVE-2024-12345",
		Title:           "Remote Code Execution in Apache Log4j",
		Description:     "A critical vulnerability allows remote code execution through JNDI lookup. This vulnerability affects Apache Log4j versions 2.0-beta9 through 2.15.0.",
		Severity:        "critical",
		CVSSScore:       9.8,
		CVSSVector:      "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
		Status:          "open",
		AffectedAssets:  []string{"server-01", "server-02", "server-05"},
		AssetCount:      3,
		DetectedAt:      now.AddDate(0, 0, -5),
		LastSeen:        now,
		PatchAvailable:  true,
		PatchVersion:    "2.17.1",
		ExploitAvailable: true,
		References: []string{
			"https://nvd.nist.gov/vuln/detail/CVE-2024-12345",
			"https://logging.apache.org/log4j/2.x/security.html",
		},
	}
}

func generateMockVulnerableAssets(count int) []VulnerableAsset {
	now := time.Now()
	assets := []VulnerableAsset{
		{
			ID:                "asset-001",
			Hostname:          "server-01",
			IPAddress:         "192.168.1.10",
			AssetType:         "server",
			OS:                "Ubuntu",
			OSVersion:         "20.04 LTS",
			Criticality:       "critical",
			Owner:             "infra-team@company.com",
			Location:          "DC-1",
			VulnerabilityCount: 12,
			CriticalVulns:     2,
			HighVulns:         4,
			RiskScore:         87.5,
			LastScanned:       now.AddDate(0, 0, -1),
		},
		{
			ID:                "asset-002",
			Hostname:          "web-server-01",
			IPAddress:         "192.168.1.20",
			AssetType:         "server",
			OS:                "CentOS",
			OSVersion:         "8.5",
			Criticality:       "high",
			Owner:             "web-team@company.com",
			Location:          "DC-1",
			VulnerabilityCount: 8,
			CriticalVulns:     1,
			HighVulns:         3,
			RiskScore:         72.3,
			LastScanned:       now.AddDate(0, 0, -1),
		},
		{
			ID:                "asset-003",
			Hostname:          "db-server-01",
			IPAddress:         "192.168.1.30",
			AssetType:         "server",
			OS:                "Windows Server",
			OSVersion:         "2019",
			Criticality:       "critical",
			Owner:             "dba-team@company.com",
			Location:          "DC-2",
			VulnerabilityCount: 15,
			CriticalVulns:     3,
			HighVulns:         5,
			RiskScore:         91.2,
			LastScanned:       now.AddDate(0, 0, -2),
		},
	}
	
	if count < len(assets) {
		return assets[:count]
	}
	return assets
}

func generateMockVulnerableAsset(id string) VulnerableAsset {
	now := time.Now()
	return VulnerableAsset{
		ID:                id,
		Hostname:          "server-01",
		IPAddress:         "192.168.1.10",
		AssetType:         "server",
		OS:                "Ubuntu",
		OSVersion:         "20.04 LTS",
		Criticality:       "critical",
		Owner:             "infra-team@company.com",
		Location:          "DC-1",
		VulnerabilityCount: 12,
		CriticalVulns:     2,
		HighVulns:         4,
		RiskScore:         87.5,
		LastScanned:       now.AddDate(0, 0, -1),
		Vulnerabilities: []VulnerabilityRef{
			{ID: "vuln-001", CVEID: "CVE-2024-12345", Severity: "critical", CVSSScore: 9.8},
			{ID: "vuln-002", CVEID: "CVE-2024-23456", Severity: "high", CVSSScore: 8.6},
		},
	}
}

func generateMockScans() []VulnerabilityScan {
	now := time.Now()
	completed1 := now.AddDate(0, 0, -2).Add(3 * time.Hour)
	completed2 := now.AddDate(0, 0, -7).Add(4 * time.Hour)
	
	return []VulnerabilityScan{
		{
			ID:            "scan-001",
			Name:          "Weekly Full Scan",
			Status:        "completed",
			StartedAt:     now.AddDate(0, 0, -2),
			CompletedAt:   &completed1,
			Duration:      10800, // 3 hours
			AssetsScanned: 342,
			VulnsFound:    247,
			CriticalFound: 23,
			HighFound:     67,
			MediumFound:   98,
			LowFound:      59,
			ScanType:      "full",
			InitiatedBy:   "security-team@company.com",
		},
		{
			ID:            "scan-002",
			Name:          "Quick Scan - Production Servers",
			Status:        "completed",
			StartedAt:     now.AddDate(0, 0, -7),
			CompletedAt:   &completed2,
			Duration:      14400, // 4 hours
			AssetsScanned: 89,
			VulnsFound:    127,
			CriticalFound: 12,
			HighFound:     34,
			MediumFound:   56,
			LowFound:      25,
			ScanType:      "quick",
			InitiatedBy:   "admin@company.com",
		},
		{
			ID:            "scan-003",
			Name:          "Emergency Scan - CVE-2024-12345",
			Status:        "running",
			StartedAt:     now.Add(-30 * time.Minute),
			AssetsScanned: 45,
			ScanType:      "targeted",
			InitiatedBy:   "security-team@company.com",
		},
	}
}

func generateMockScan(id string) VulnerabilityScan {
	now := time.Now()
	completed := now.AddDate(0, 0, -2).Add(3 * time.Hour)
	
	return VulnerabilityScan{
		ID:            id,
		Name:          "Weekly Full Scan",
		Status:        "completed",
		StartedAt:     now.AddDate(0, 0, -2),
		CompletedAt:   &completed,
		Duration:      10800,
		AssetsScanned: 342,
		VulnsFound:    247,
		CriticalFound: 23,
		HighFound:     67,
		MediumFound:   98,
		LowFound:      59,
		ScanType:      "full",
		InitiatedBy:   "security-team@company.com",
	}
}

func generateMockVulnerabilityTrends(days int) []VulnerabilityTrend {
	trends := []VulnerabilityTrend{}
	now := time.Now()
	
	for i := days - 1; i >= 0; i-- {
		date := now.AddDate(0, 0, -i)
		trends = append(trends, VulnerabilityTrend{
			Date:     date.Format("2006-01-02"),
			Critical: 23 + i,
			High:     67 + i*2,
			Medium:   98 + i*3,
			Low:      59 + i,
			Total:    247 + i*7,
		})
	}
	
	return trends
}

